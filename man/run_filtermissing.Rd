% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_filtermissing.R
\name{run_filtermissing}
\alias{run_filtermissing}
\title{Filter Features by Missing Value Threshold}
\usage{
run_filtermissing(
  x,
  metadata,
  threshold = 0.2,
  filter_by_group = TRUE,
  include_QC = FALSE,
  group_col = "Group",
  qc_types = c("QC", "SQC", "EQC"),
  zero_as_missing = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{x}{Matrix or data frame. Numeric data with samples in rows and features in columns.
Missing values should be represented as NA. Zero values can optionally be treated
as missing via the \code{zero_as_missing} parameter.}

\item{metadata}{Data frame. Sample metadata with number of rows equal to nrow(x).
Must contain a column specified by \code{group_col} when \code{filter_by_group = TRUE}.}

\item{threshold}{Numeric. Maximum proportion of missing values allowed (0-1).
Features with missing proportion >= threshold are removed. Default: 0.2 (20\%).}

\item{filter_by_group}{Logical. If TRUE, assess missingness within each group separately.
A feature is kept if it passes the threshold in at least one group. Default: TRUE.}

\item{include_QC}{Logical. If TRUE, include QC samples in missingness calculation.
Default: FALSE (QC samples are excluded from assessment).}

\item{group_col}{Character. Name of the column in \code{metadata} containing group information.
Required when \code{filter_by_group = TRUE}. Default: "Group".}

\item{qc_types}{Character vector. Group labels that identify QC samples. These samples
are excluded from missingness calculation when \code{include_QC = FALSE}. Default: c("QC", "SQC", "EQC").}

\item{zero_as_missing}{Logical. If TRUE, treat zero values as missing (NA) before
applying the filter. This is common in metabolomics where zeros often represent
values below detection limit rather than true zeros. Default: TRUE.}

\item{verbose}{Logical. Print progress messages. Default: TRUE.}
}
\value{
A list of class "run_filtermissing" containing:
\item{data}{Matrix or data frame of filtered data (same class as input \code{x})}
\item{features_removed}{Character vector of removed feature names}
\item{features_kept}{Character vector of retained feature names}
\item{n_features_before}{Integer. Number of features before filtering}
\item{n_features_after}{Integer. Number of features after filtering}
\item{n_features_removed}{Integer. Number of features removed}
\item{n_zeros_converted}{Integer. Number of zero values converted to NA (if applicable)}
\item{parameters}{List of parameters used}
\item{missingness_summary}{Data frame with per-feature missingness statistics}
}
\description{
Removes features (columns) that exceed a specified missing value threshold.
Can assess missingness globally or by group, with optional inclusion of QC samples.
Supports treating zero values as missing, which is common in metabolomics data.
}
\details{
This function filters features based on the proportion of missing values (NAs).

\strong{Zero values treated as missing}

In metabolomics data, zero values often represent one of the following:
\itemize{
\item Peak intensities below the detection limit
\item Failed peak integration
\item Metabolites not detected in the sample
}

When \code{zero_as_missing = TRUE} (default), zero values are converted to
missing values before filtering. This is recommended for most untargeted
metabolomics datasets.

Set \code{zero_as_missing = FALSE} only if one of the following is true:
\itemize{
\item Your preprocessing pipeline already converted zeros to NA
\item Zero represents a true biological absence with quantitative meaning
\item Your dataset contains negative values (for example after baseline correction)
}

\strong{Filtering strategies}

Two filtering modes are available:

\itemize{
\item \strong{Global filtering} (\code{filter_by_group = FALSE}):
Missingness is calculated across all eligible samples. Features with
missing proportion greater than or equal to \code{threshold} are removed.

\item \strong{Group-wise filtering} (\code{filter_by_group = TRUE}):
Missingness is calculated separately within each group. A feature is
retained if it satisfies the threshold in at least one group. This approach
is less stringent and helps preserve group-specific features.
}

\strong{QC sample handling}

When \code{include_QC = FALSE}, samples whose group labels match
\code{qc_types} are excluded from missingness calculations. This is
recommended because QC samples often exhibit different missingness
patterns compared with biological samples.
}
\examples{
\dontrun{
# Simulate data with zeros and NAs
set.seed(123)
x <- matrix(abs(rnorm(100 * 50, mean = 100)), nrow = 100, ncol = 50)
x[sample(length(x), 300)] <- 0    # Add zeros
x[sample(length(x), 200)] <- NA   # Add NAs
colnames(x) <- paste0("Feature", 1:50)

metadata <- data.frame(
  Sample = paste0("S", 1:100),
  Group = rep(c("Control", "Treatment", "QC"), c(40, 40, 20))
)

# Treat zeros as missing (default)
result1 <- run_filtermissing(x, metadata, threshold = 0.3)

# Keep zeros as valid values
result2 <- run_filtermissing(x, metadata, threshold = 0.3, 
                              zero_as_missing = FALSE)

# Group-wise filtering with zeros as missing
result3 <- run_filtermissing(x, metadata, threshold = 0.3, 
                              filter_by_group = TRUE,
                              zero_as_missing = TRUE)
}
}
\references{
Broadhurst, D.I. (2025). QC:MXP Repeat Injection based Quality Control, Batch Correction,
Exploration & Data Cleaning (Version 2.1) Zendono. \doi{10.5281/zenodo.16824822}.
Retrieved from \url{https://github.com/broadhurstdavid/QC-MXP}.

Wei, R., Wang, J., Su, M., Jia, E., Chen, S., Chen, T., & Ni, Y. (2018).
Missing Value Imputation Approach for Mass Spectrometry-based Metabolomics Data.
Scientific Reports, 8(1), 663. \doi{10.1038/s41598-017-19120-0}
}
\author{
John Lennon L. Calorio
}
