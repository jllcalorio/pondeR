% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_pca.R
\name{run_pca}
\alias{run_pca}
\title{Perform Principal Component Analysis}
\usage{
run_pca(
  x,
  metadata,
  scale_method = NULL,
  transform_method = NULL,
  group = "Group",
  exclude = NULL,
  verbose = TRUE
)
}
\arguments{
\item{x}{Matrix or data frame. Numeric data with samples in rows and features in columns.
Can be output from \code{run_scale()} or raw data (which will be scaled if \code{scale_method}
is specified).}

\item{metadata}{Data frame. Sample metadata with number of rows equal to nrow(x).
Must contain columns for grouping, batch information, and sample identifiers.}

\item{scale_method}{Character or NULL. Scaling method to apply before PCA if \code{x} is not
already scaled. Options: "mean", "auto", "pareto". If NULL (default) and \code{x} is not
from \code{run_scale()}, a warning is issued and PCA proceeds without additional scaling.}

\item{transform_method}{Character or NULL. Transformation method to apply before scaling
and PCA. Options: "log2", "log10", "sqrt", "cbrt", "vsn", "glog". Default: NULL (no transformation).}

\item{group}{Character. Name of column in \code{metadata} containing group labels for sample
exclusion. Required if \code{exclude} is specified. Default: "Group".}

\item{exclude}{Character vector or NULL. Group labels (from the \code{group} column) to exclude
from PCA analysis. For example, c("QC", "Blank") excludes all samples with these group
labels. Default: NULL (include all samples).}

\item{verbose}{Logical. Print progress messages. Default: TRUE.}
}
\value{
A list of class "run_pca" containing:
\item{scores}{Matrix of PC scores (samples × PCs)}
\item{loadings}{Matrix of PC loadings (features × PCs)}
\item{variance_explained}{Numeric vector of variance explained (\%) per PC}
\item{eigenvalues}{Numeric vector of eigenvalues per PC}
\item{cumulative_variance}{Numeric vector of cumulative variance explained (\%) per PC}
\item{center_values}{Numeric vector of centering values used (if any)}
\item{scale_values}{Numeric vector of scaling values used (if any)}
\item{pca_object}{Original prcomp object from stats::prcomp}
\item{data_used}{Matrix of data used for PCA (after any transformation/scaling)}
\item{metadata}{Data frame of metadata aligned with PCA scores}
\item{n_samples}{Integer. Number of samples used in PCA}
\item{n_samples_excluded}{Integer. Number of samples excluded}
\item{n_features}{Integer. Number of features}
\item{n_pcs}{Integer. Number of PCs computed}
\item{excluded_groups}{Character vector of excluded group labels}
\item{preprocessing}{List documenting preprocessing steps applied}
\item{parameters}{List of parameters used}
}
\description{
Performs Principal Component Analysis (PCA) on preprocessed metabolomics data.
Optionally applies scaling and transformation before PCA if the input data
has not been pre-scaled. Supports sample exclusion by group.
}
\details{
\strong{Sample Exclusion:}

The \code{exclude} parameter allows removal of specific sample groups before PCA:
\itemize{
\item Common use: Exclude QC samples (\code{exclude = c("QC", "SQC", "EQC")})
\item Multiple groups can be excluded: \code{exclude = c("QC", "Blank", "Failed")}
\item Exclusion is performed before any preprocessing steps
\item Excluded samples are not included in transformation/scaling calculations
}

\strong{Input Data Requirements:}

The function accepts data in two forms:
\enumerate{
\item \strong{Pre-scaled data} from \code{run_scale()}: PCA is performed directly without
additional preprocessing. This is the recommended workflow.
\item \strong{Raw data}: If \code{scale_method} is specified, the function will first apply
optional transformation (via \code{transform_method}), then scaling (via \code{scale_method}),
before performing PCA.
}

\strong{PCA Methodology:}

PCA is performed using singular value decomposition (SVD) via \code{stats::prcomp()}.
The function assumes data is appropriately preprocessed (normalized, transformed,
and scaled) before analysis. PCA is performed without additional centering or
scaling (\verb{center = FALSE, scale. = FALSE}) as these should have been applied
during the scaling step.

\strong{Interpretation:}
\itemize{
\item \strong{PC Scores}: Coordinates of samples in the principal component space.
Used for visualization and identifying patterns/clusters.
\item \strong{PC Loadings}: Contribution of each feature to each principal component.
Features with high absolute loadings drive separation along that PC.
\item \strong{Variance Explained}: Percentage of total variance captured by each PC.
First few PCs typically capture most variance in metabolomics data.
\item \strong{Eigenvalues}: Variance captured by each PC in original units.
Eigenvalue > 1 (Kaiser criterion) often used to determine significant PCs.
}

\strong{Scaling Recommendations:}
\itemize{
\item \strong{Auto-scaling} ("auto"): Recommended for PCA. Gives equal weight to all
features regardless of magnitude.
\item \strong{Pareto-scaling} ("pareto"): Alternative that partially preserves variance
structure. Can be useful when feature magnitudes carry biological meaning.
\item \strong{Mean-centering} ("mean"): Only centers data. Use when features are already
on comparable scales.
}
}
\examples{
\dontrun{
# Simulate data
set.seed(123)
x <- matrix(rnorm(100 * 50, mean = 100, sd = 20),
            nrow = 100, ncol = 50)
colnames(x) <- paste0("Feature", 1:50)
rownames(x) <- paste0("Sample", 1:100)

metadata <- data.frame(
  Sample = paste0("Sample", 1:100),
  Group = rep(c("Control", "Treatment", "QC"), c(40, 40, 20)),
  Batch = rep(1:4, each = 25),
  Time = rep(c(0, 6, 12, 24), 25)
)

# PCA on pre-scaled data (recommended)
scaled_result <- run_scale(x, method = "auto")
pca_result <- run_pca(scaled_result$data, metadata)

# PCA excluding QC samples
pca_result2 <- run_pca(scaled_result$data, metadata, 
                       group = "Group",
                       exclude = "QC")

# PCA with automatic scaling, excluding multiple groups
pca_result3 <- run_pca(x, metadata, 
                       scale_method = "auto",
                       group = "Group",
                       exclude = c("QC", "Blank"))

# PCA with transformation and scaling
pca_result4 <- run_pca(x, metadata, 
                       transform_method = "log2",
                       scale_method = "pareto",
                       group = "Group",
                       exclude = "QC")

# View results
print(pca_result)
summary(pca_result)
}
}
\references{
Becker, R.A., Chambers, J.M., & Wilks, A.R. (1988). The New S Language.
Wadsworth & Brooks/Cole. \doi{10.1201/9781351074988}

Mardia, K.V., Kent, J.T., & Bibby, J.M. (1979). Multivariate Analysis.
London: Academic Press.

Venables, W.N., & Ripley, B.D. (2002). Modern Applied Statistics with S.
Springer-Verlag.

van den Berg, R.A., Hoefsloot, H.C., Westerhuis, J.A., Smilde, A.K., & van der Werf, M.J. (2006).
Centering, scaling, and transformations: improving the biological information content of
metabolomics data. BMC Genomics, 7, 142. \doi{10.1186/1471-2164-7-142}
}
\author{
John Lennon L. Calorio
}
